
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======================================
    // RÈGLES FIRESTORE CORRIGÉES ET OPTIMISÉES
    // ======================================
    
    // ======================================
    // CAMPAGNES - Accès utilisateur seulement
    // ======================================
    match /campaigns/{campaignId} {
      // Lecture : utilisateur authentifié ET propriétaire
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      
      // Création : utilisateur authentifié ET défini comme propriétaire
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      
      // Mise à jour : utilisateur authentifié ET propriétaire existant
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
      
      // Suppression : utilisateur authentifié ET propriétaire
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ======================================
    // AFFILIÉS - Accès utilisateur seulement
    // ======================================
    match /affiliates/{affiliateId} {
      // Lecture : utilisateur authentifié ET propriétaire
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      
      // Création : utilisateur authentifié ET défini comme propriétaire
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      
      // Mise à jour : utilisateur authentifié ET propriétaire existant
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
      
      // Suppression : utilisateur authentifié ET propriétaire
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ======================================
    // CLICS - Plus permissif pour le tracking
    // ======================================
    match /clicks/{clickId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Création : tous les utilisateurs authentifiés (pour tracking public)
      allow create: if request.auth != null;
      
      // Mise à jour : propriétaire seulement
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
      
      // Suppression : propriétaire seulement
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ======================================
    // CONVERSIONS - Plus permissif pour le tracking
    // ======================================
    match /conversions/{conversionId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Création : tous les utilisateurs authentifiés (pour tracking public)
      allow create: if request.auth != null;
      
      // Mise à jour : propriétaire seulement
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
      
      // Suppression : propriétaire seulement
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ======================================
    // LIENS COURTS - Lecture publique nécessaire
    // ======================================
    match /shortLinks/{linkId} {
      // Lecture publique (pour redirection)
      allow read: if true;
      
      // Création : utilisateur authentifié
      allow create: if request.auth != null;
      
      // Mise à jour : propriétaire seulement
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
      
      // Suppression : propriétaire seulement
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ======================================
    // SÉCURITÉ PAR DÉFAUT
    // ======================================
    
    // Bloquer tout le reste
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
